const e=Object.prototype.hasOwnProperty;function t(e){return Array.isArray(e)}function n(e){return !!e&&"object"==typeof e&&!t(e)}function o(e){return "function"==typeof e}function i(e){const t=typeof e;return void 0!==e&&"object"!==t&&"function"!==t}function r(e){return "boolean"==typeof e}function s(e){return e instanceof Promise}function c(n){if(!n)return !1;if(t(n))return 0===n.length;for(const t in n)if(e.call(n,t))return !1;return !0}const l=new Set(["boolean","string","number"]);function u(e){return !!e.parent}let a=0;const f=[],d={current:void 0,inRemoteChange:!1};function p(e,t){if(a){const n=d.current;if(n){n.nodes||(n.nodes=new Map);const o=n.nodes.get(e);o?(o.track=o.track||t,o.num++):n.nodes.set(e,{node:e,track:t,num:1});}}}const v=Symbol.toPrimitive,g=Symbol("isObservable"),h=Symbol("isEvent"),y=Symbol("getNode"),m=Symbol("delete"),k=Symbol("opaque"),w=Symbol("optimized"),b=new Map,P=new Map;function O(e){const t=e.root,n=t.activate;n&&(t.activate=void 0,n());}function A(e,t){return p(e,t),S(e)}function S(e){return O(e),M(e)}const _=[];function M(e){let t=0,n=e;for(;u(n);)_[t++]=n.key,n=n.parent;let o=e.root._;for(let e=t-1;o&&e>=0;e--){const t=_[e];o=o instanceof Map||o instanceof WeakMap?o.get(t):o[t];}return o}function C(e,t){var n;let o=null===(n=e.children)||void 0===n?void 0:n.get(t);return o||(o={root:e.root,parent:e,key:t},e.children||(e.children=new Map),e.children.set(t,o)),o}function j(e){let t=M(e);if(!t)if(u(e)){t=j(e.parent)[e.key]={};}else t=e.root._={};return t}let I,R=0,z=!1,E=!1,x=[],T=new Map;function H(){T.size>0&&B(!0);}function L(e,t){return function(){return function(e,t){let n=e?JSON.parse(JSON.stringify(e)):{};for(let e=0;e<t.length;e++){const{path:o,prevAtPath:i}=t[e];let r=n;if(o.length>0){let e;for(e=0;e<o.length-1;e++)r=r[o[e]];r[o[e]]=i;}else n=i;}return n}(e,t)}}function W(e,t,n,o,i){const r=new Map;D(r,e,t,[],[],t,n,!0,o,i),N(r,!0);const s=T.get(e);s?s.value=t:T.set(e,{value:t,prev:n,level:o,whenOptimizedOnlyIf:i}),R<=0&&J();}function D(e,n,o,i,r,s,c,l,u,a){if(function(e,t,n,o,i,r,s,c,l,u){if(c?t.listenersImmediate:t.listeners){const c={path:o,pathTypes:i,valueAtPath:r,prevAtPath:s},a=e.get(t);a&&o.length>0?a.changes.push(c):e.set(t,{level:l,value:n,whenOptimizedOnlyIf:u,changes:[c]});}}(e,n,o,i,r,s,c,l,u,a),n.parent){const f=n.parent;if(f){D(e,f,M(f),[n.key].concat(i),[t(o)?"array":"object"].concat(r),s,c,l,u+1,a);}}}function N(e,t){const n=new Set;e.forEach((({changes:e,level:o,value:i,whenOptimizedOnlyIf:r},s)=>{const c=t?s.listenersImmediate:s.listeners;if(c){let t;const s=Array.from(c);for(let c=0;c<s.length;c++){const l=s[c],{track:u,noArgs:a,listener:f}=l;if(!n.has(f)){(!0===u||"shallow"===u?o<=0:u!==w||r&&o<=0)&&(a||t||(t={value:i,getPrevious:L(i,e),changes:e}),u||n.add(f),f(t));}}}}));}function J(){const e=T;T=new Map;const t=new Map;e.forEach((({value:e,prev:n,level:o,whenOptimizedOnlyIf:i},r)=>{D(t,r,e,[],[],e,n,!1,o,i);})),N(t,!1);}function K(e,t){t&&x.push(t),q();try{e();}finally{B();}}function q(){R++,I||(I=setTimeout(H,0));}function B(e){if(R--,R<=0||e)if(z)E=!0;else {I&&(clearTimeout(I),I=void 0),R=0;const e=x;e.length&&(x=[]),z=!0,J(),z=!1;for(let t=0;t<e.length;t++)e[t]();E&&(E=!1,B(!0));}}function F(e){return e&&!!e[g]}function G(e,t){let n=e;return o(n)&&(n=t?n(t):n()),F(n)?n.get():n}function Q(e){return e[y]}function U(e,t){var n;const o=null===(n=Q(e))||void 0===n?void 0:n.root;o&&(o.locked=t);}function V(e,t,n={}){const{initial:o,immediate:i,noArgs:r}=n;let{trackingType:s}=n;"optimize"===s&&(s=w);let c=i?e.listenersImmediate:e.listeners;c||(c=new Set,i?e.listenersImmediate=c:e.listeners=c),O(e);const l={listener:t,track:s,noArgs:r};c.add(l);let u=e.parent;for(;u&&!u.descendantHasListener;)u.descendantHasListener=!0,u=u.parent;if(o){const n=M(e);t({value:n,changes:[{path:[],pathTypes:[],prevAtPath:n,valueAtPath:n}],getPrevious:()=>{}});}return ()=>c.delete(l)}function X(e,t,n,o){let i=[];return null==e||e.forEach((e=>{const{node:r,track:s}=e;i.push(V(r,t,{trackingType:s,immediate:o,noArgs:n}));})),()=>{if(i){for(let e=0;e<i.length;e++)i[e]();i=void 0;}}}function Y(e,t,n,o,i){let r,s,c,l,u,p=t;return F(e)?(s=e.peek(),c=e.onChange(t,{noArgs:!0}),u=i&&e.onChange(t,{noArgs:!0})):(f.push(d.current),a++,d.current={},s=e?G(e,n):e,l=d.current,r=l.nodes,a--,a<0&&(a=0),d.current=f.pop()),(null==n?void 0:n.cancel)||(c=X(r,p,true,null==o?void 0:o.immediate),u=i&&(()=>X(r,p,true))),{value:s,dispose:c,resubscribe:u}}const Z=new Set(["copyWithin","fill","from","pop","push","reverse","shift","sort","splice","unshift"]),$=new Set(["every","filter","find","findIndex","forEach","includes","join","map","some"]),ee=new Set(["filter","find"]),te=new Map,ne=new Map([["get",A],["set",se],["peek",S],["onChange",V],["assign",function(e,t){const n=ie(e);q(),i(e.root._)&&(e.root._={});e.isAssigning=(e.isAssigning||0)+1;try{Object.assign(n,t);}finally{e.isAssigning--;}return B(),n}],["delete",function(e,t){void 0===t&&u(e)&&(t=e.key,e=e.parent);ce(e,t,m,-1);}],["toggle",function(e){const t=M(e);if(void 0===t||r(t))return se(e,!t),!t}]]);function oe(e,r,s){if(n(r)&&r[k]||n(s)&&s[k]){const t=r!==s;return t&&(e.listeners||e.listenersImmediate)&&W(e,r,s,0),t}const c=t(r);let l,u;const a=r instanceof Map,f=r?a?Array.from(r.keys()):Object.keys(r):[],d=s?a?Array.from(s.keys()):Object.keys(s):[];let p,v,g,h=!1;if(c&&t(s)){if(s.length>0){const t=s[0];if(void 0!==t&&(p=function(e,t){let i=n(e)?"id"in e?"id":"key"in e?"key":"_id"in e?"_id":"__id"in e?"__id":void 0:void 0;if(!i&&t.parent){const e=M(t.parent)[t.key+"_keyExtractor"];e&&o(e)&&(i=e);}return i}(t,e),p&&(v=o(p),l=new Map,u=[],e.children)))for(let t=0;t<s.length;t++){const n=s[t];if(n){const o=e.children.get(t+"");if(o){const e=v?p(n):n[p];l.set(e,o);}}}}}else if(s&&(!r||r.hasOwnProperty)){const t=d.length;for(let n=0;n<t;n++){const t=d[n];if(!f.includes(t)){h=!0;const n=C(e,t),o=a?s.get(t):s[t];void 0!==o&&(i(o)||oe(n,void 0,o),(n.listeners||n.listenersImmediate)&&W(n,void 0,o,0));}}}if(r&&!i(r)){const t=f.length;h=h||(null==f?void 0:f.length)!==(null==d?void 0:d.length);const n=h;let o=!1;if(e.descendantHasListener||!h){for(let d=0;d<t;d++){const t=f[d],g=a?r.get(t):r[t],y=a?null==s?void 0:s.get(t):null==s?void 0:s[t];let m=g!==y;if(m){const r=p&&g?v?p(g):g[p]:void 0;let a=C(e,t);if(c&&void 0!==r){const i=void 0!==r?null==l?void 0:l.get(r):void 0;if(i){if(void 0!==i&&i.key!==t){const r=s[i.key];n&&(a=i,e.children.delete(a.key),a.key=t,u.push([t,a])),o=!0,m=r!==g;}}else m=!1,h=!0;}if(m)if(i(g))h=!0;else {const e=(!h||a.descendantHasListener)&&oe(a,g,y);h=h||e;}!m&&n||(a.listeners||a.listenersImmediate)&&W(a,g,y,0,!n);}}if(u)for(let t=0;t<u.length;t++){const[n,o]=u[t];e.children.set(n,o);}}g=h||o;}else void 0!==s&&(g=!0);return null!=g&&g}function ie(e,t){return void 0!==t&&(e=C(e,t)),e.proxy||(e.proxy=new Proxy(e,re))}const re={get(e,r){if(r===v)throw new Error("[legend-state] observable is not a primitive.");if(r===g)return !0;if(r===h)return !1;if(r===y)return e;const s=S(e);if(s instanceof Map||s instanceof WeakMap||s instanceof Set||s instanceof WeakSet){const t=function(e,t,n){const i=null==n?void 0:n[t];if(o(i))return function(o,i,r){const s=arguments.length;if("get"===t){if(s>0&&"boolean"!=typeof o&&o!==w)return ie(e,o)}else if("set"===t){if(2===s){const t=n.get(o),r=n.set(o,i);return t!==i&&le(C(e,o),i,t),r}}else if("delete"===t){if(s>0){const t=n.get?n.get(o):o,i=n.delete(o);return i&&le(C(e,o),void 0,t),i}}else {if("clear"===t){const t=new Map(n),o=n.size;return n.clear(),void(o&&le(e,n,t))}if("add"===t){const i=new Set(n),r=n.add(o);return n.has(t)||W(e,r,i,0),r}}const c=ne.get(t);if(!c)return n[t](o,i);switch(s){case 0:return c(e);case 1:return c(e,o);case 2:return c(e,o,i);default:return c(e,o,i,r)}}}(e,r,s);if(void 0!==t)return t}const c=ne.get(r);if(c)return function(t,n,o){switch(arguments.length){case 0:return c(e);case 1:return c(e,t);case 2:return c(e,t,n);default:return c(e,t,n,o)}};const l=te.get(r);if(l)return l.get(e);const a=i(s);if((null==s||a)&&P.size&&(e.isActivatedPrimitive||b.has(r))){e.isActivatedPrimitive=!0;const t=P.get(r);if(void 0!==t)return o(t)?t(ie(e)):t}const f=null==s?void 0:s[r];if(n(s)&&s[k])return f;if(o(f)){if(t(s)){if(Z.has(r))return (...n)=>function(e,n,o,...i){var r;const s=t(n)&&n.slice()||n,c=n[o].apply(n,i);if(e){const t=u(e),o=t?e.key:"_";(t?M(e.parent):e.root)[o]=s,ce(null!==(r=e.parent)&&void 0!==r?r:e,t?o:void 0,n);}return c}(e,s,r,...n);if($.has(r))return p(e),function(t,n){function o(n,o,i){return t(ie(e,o+""),o,i)}if(ee.has(r)){const t="find"===r,n=[];for(let i=0;i<s.length;i++)if(o(s[i],i,s)){const o=ie(e,i+"");if(t)return o;n.push(o);}return t?void 0:n}return s[r](o,n)}}return f.bind(s)}return i(f)&&t(s)&&"length"===r?(p(e,!0),f):ie(e,r)},getPrototypeOf(e){const t=M(e);return null!==t&&"object"==typeof t?Reflect.getPrototypeOf(t):null},ownKeys(e){const n=M(e);if(i(n))return [];const o=n?Reflect.ownKeys(n):[];return p(e,!0),t(n)&&"length"===o[o.length-1]&&o.splice(o.length-1,1),o},getOwnPropertyDescriptor(e,t){const n=M(e);return i(n)?void 0:Reflect.getOwnPropertyDescriptor(n,t)},set(e,t,n){if(e.isSetting)return Reflect.set(e,t,n);if(e.isAssigning)return ce(e,t,n),!0;const o=te.get(t);return !!o&&o.set(e,n)},deleteProperty:(e,t)=>!!e.isSetting&&Reflect.deleteProperty(e,t),has(e,t){const n=M(e);return Reflect.has(n,t)}};function se(e,t){return e.parent?ce(e.parent,e.key,t):ce(e,void 0,t)}function ce(e,t,r,s){if(e.root.locked&&!e.root.set)throw new Error("[legend-state] Modified locked observable");const c=r===m;c&&(r=void 0);const l=!e.parent&&void 0===t;l&&(t="_");const u=l?e:C(e,t),a=l?e.root:j(e),f=a[t],d=o(r),p=i(r=!e.isAssigning&&d?r(f):n(r)&&(null==r?void 0:r[g])?r.peek():r)||r instanceof Date;try{e.isSetting=(e.isSetting||0)+1,c?delete a[t]:a[t]=r;}finally{e.isSetting--;}return e.root.locked&&e.root.set&&e.root.set(e.root._),r!==f&&le(e,r,f,u,p,l,s),d?r:l?ie(e):ie(e,t)}function le(e,n,o,r,s,l,u){r||(r=e),q();let a=s,f=!1;(!s||o&&!i(o))&&(a=oe(r,n,o),t(n)&&(f=(null==n?void 0:n.length)!==(null==o?void 0:o.length))),(s||!n||c(n)?n!==o:a)&&W(s&&l?e:r,n,o,(null!=u?u:void 0===o)?-1:a?0:1,f),B();}function ue(e){this._node=e,this.set=this.set.bind(this),this.toggle=this.toggle.bind(this);}function ae(e,t){const n=s(e),o={root:{_:n?void 0:e}},i=t||(r=e,l.has(typeof r))?new ue(o):ie(o);var r;return n&&(e.catch((e=>{i.set({error:e});})),e.then((e=>{i.set(e);}))),i}function fe(e){return ae(e)}function de(e,t,n){let i,r;o(t)?i=t:n=t;const s={num:0},c=function(){s.onCleanup&&(s.onCleanup(),s.onCleanup=void 0),q(),delete s.value,null==r||r();const{dispose:t,value:o}=Y(e,c,s,n);r=t,s.value=o,s.onCleanupReaction&&(s.onCleanupReaction(),s.onCleanupReaction=void 0),i&&(s.num>0||!(null==e?void 0:e[h]))&&s.previous!==s.value&&i(s),s.previous=s.value,s.num++,B();};return c(),()=>{var e,t;null===(e=s.onCleanup)||void 0===e||e.call(s),s.onCleanup=void 0,null===(t=s.onCleanupReaction)||void 0===t||t.call(s),s.onCleanupReaction=void 0,r();}}function pe(e,t){const n=fe();U(n,!0);const o=Q(n),i=function(e){e!==n.peek()&&(U(n,!1),se(o,e),U(n,!0));};return o.root.activate=()=>{de(e,(({value:e})=>{s(e)?e.then((e=>i(e))):i(e);}),{immediate:!0});},t&&(o.root.set=e=>{K((()=>t(e)));}),n}function ve(e,o,i){let r;if(de((function(s){const l=G(e);(i?function(e){return !(!e||(n(e)||t(e))&&c(e))}(l):l)&&(r=l,null==o||o(l),s.cancel=!0);})),void 0!==r)return Promise.resolve(r);{const e=new Promise((e=>{if(o){const t=o;o=n=>{const o=t(n);e(o);};}else o=e;}));return e}}function ge(e,t){return ve(e,t,!1)}Object.defineProperty(ue.prototype,y,{configurable:!0,get(){return this._node}}),Object.defineProperty(ue.prototype,g,{configurable:!0,value:!0}),Object.defineProperty(ue.prototype,h,{configurable:!0,value:!1}),ue.prototype.peek=function(){return S(this._node)},ue.prototype.get=function(){return A(this._node)},ue.prototype.set=function(e){return se(this._node,e)},ue.prototype.toggle=function(){const e=this.peek();return (void 0===e||r(e))&&this.set(!e),!e},ue.prototype.delete=function(){return this.set(void 0),this},ue.prototype.onChange=function(e,t){return V(this._node,e,t)};

export { F, K, Y, c, fe as f, ge as g, o, pe as p, t };
